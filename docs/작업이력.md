# OPASNET 4A - 작업이력서

## 프로젝트 정보
- **프로젝트명**: OPASNET 4A 장비관리 시스템
- **목적**: 4/A본부 엑셀 장비관리대장 → 웹 시스템 전환
- **참고 프로젝트**: TheBreeze 그룹웨어 API (MVC+DAO 패턴)
- **작업일**: 2026-02-06

---

## 1단계: 프로젝트 초기화 및 기본 설정

### 작업 내용
- `npm init` 으로 프로젝트 생성
- 필요 패키지 설치:
  - express, pg, ejs, express-ejs-layouts
  - express-session, connect-pg-simple
  - bcryptjs, dotenv, morgan, cookie-parser
  - http-errors, winston, winston-daily-rotate-file
  - bootstrap, bootstrap-icons, moment, app-root-path
- Express 5 앱 설정 (`app.js`)
- 서버 진입점 (`bin/www`) - TheBreeze 패턴 동일

### 생성 파일
- `package.json` - 프로젝트 설정
- `app.js` - Express 앱 (미들웨어, 라우터, 에러핸들러)
- `bin/www` - HTTP 서버 생성 및 포트 바인딩

---

## 2단계: 환경설정 (config/)

### 작업 내용
TheBreeze 프로젝트의 config 구조를 그대로 차용:
- `config/env.js` - NODE_ENV에 따라 `.env.{환경}` 파일 로드
- `config/database.js` - PostgreSQL Pool 생성 및 export
- `config/logger.js` - Winston 로거 (daily rotate, writeLog 메서드)

### 환경변수 (.env)
```
APPLICATION_STATUS - 환경구분 (development/production)
PORT - 서버 포트 (기본 3000)
DATABASE_HOST/USER/PASSWORD/PORT/DATABASE - DB 접속정보
SESSION_SECRET - 세션 시크릿 키
```

### 생성 파일
- `config/env.js`
- `config/database.js`
- `config/logger.js`
- `config/.env.development`
- `config/.env.production`
- `config/.env.example`

---

## 3단계: DB 스키마 설계

### 테이블 구조

#### users (사용자)
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | SERIAL PK | 사용자 ID |
| username | VARCHAR(50) UNIQUE | 로그인 아이디 |
| password | VARCHAR(255) | bcrypt 해시 비밀번호 |
| name | VARCHAR(100) | 이름 |
| department | VARCHAR(100) | 부서 |
| role | VARCHAR(20) | 'admin' 또는 'user' |
| created_at | TIMESTAMP | 생성일시 |

#### equipment (장비)
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | SERIAL PK | 장비 ID |
| category | VARCHAR(50) | 구분 (Switch, Router 등) |
| vendor | VARCHAR(50) | 벤더 |
| model_name | VARCHAR(100) | 모델명 |
| uplink | VARCHAR(50) | 업링크 |
| power_redundancy | VARCHAR(10) | 파워이중화 (x/o) |
| asset_number | VARCHAR(50) UNIQUE | 자산번호 |
| serial_number | VARCHAR(100) | S/N |
| location | VARCHAR(100) | 위치 |
| status | VARCHAR(20) | available/rented/reserved |
| description | TEXT | 비고 |
| created_at/updated_at | TIMESTAMP | 등록/수정일시 |

#### rental_history (대여기록)
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | SERIAL PK | 기록 ID |
| equipment_id | INT FK | 장비 참조 |
| user_id | INT FK | 처리자 참조 |
| action | VARCHAR(20) | rent/return/reserve |
| borrower_name/dept | VARCHAR | 대여자 정보 |
| rent_date | TIMESTAMP | 대여일 |
| return_date | TIMESTAMP | 반납예정일 |
| actual_return_date | TIMESTAMP | 실제반납일 |
| use_location | VARCHAR(200) | 사용장소 |
| purpose | TEXT | 사용목적 |
| notes | TEXT | 특이사항 |

### 기본 데이터
- admin 계정: admin / admin123
- 샘플 장비 8건 (Switch, Router, Server, Firewall, AP)

### 생성 파일
- `sql/init.sql`

---

## 4단계: 인증 시스템

### 작업 내용
- 세션 기반 인증 (express-session + connect-pg-simple)
- 로그인/로그아웃 처리
- 미들웨어: `isAuthenticated` (로그인 확인), `isAdmin` (관리자 확인)

### 생성 파일
- `middleware/auth.js` - 인증/권한 미들웨어
- `app/controllers/auth_controller.js` - 로그인/로그아웃 컨트롤러
- `app/views/login.ejs` - 로그인 페이지
- `routes/index_route.js` - 인증 라우트

---

## 5단계: DAO 계층

### 작업 내용
TheBreeze 패턴 그대로 적용:
- static async 메서드
- try-catch + logger.writeLog
- pool.query + parameterized query
- 에러 시 null 반환

### DAO 클래스별 메서드

#### user_dao.js
- `findByUsername` - 로그인용 조회
- `findAll` - 목록
- `findById` - 상세
- `create` - 등록
- `update` - 수정
- `updatePassword` - 비밀번호 변경
- `delete` - 삭제

#### equipment_dao.js
- `findAll` - 목록 (검색/필터/페이지네이션)
- `findById` - 상세
- `create` - 등록
- `update` - 수정
- `delete` - 삭제
- `updateStatus` - 상태변경
- `getFilterOptions` - 필터 옵션 조회
- `getStats` - 통계 (전체/사용가능/대여중/예약중)

#### rental_dao.js
- `create` - 대여/반납/예약 기록 생성
- `processReturn` - 반납처리 (실제반납일 기록)
- `findByEquipmentId` - 장비별 기록
- `findActiveRental` - 현재 대여건 조회
- `findAll` - 전체 기록 (검색/페이지네이션)

### 생성 파일
- `app/dao/user_dao.js`
- `app/dao/equipment_dao.js`
- `app/dao/rental_dao.js`

---

## 6단계: 컨트롤러 + 라우트

### equipment_controller.js
- `list` - 장비현황 (GET /equipment)
- `createForm` - 등록폼 (GET /equipment/create) [관리자]
- `create` - 등록처리 (POST /equipment/create) [관리자]
- `editForm` - 수정폼 (GET /equipment/:id/edit) [관리자]
- `update` - 수정처리 (POST /equipment/:id/edit) [관리자]
- `delete` - 삭제 (POST /equipment/:id/delete) [관리자]
- `detail` - 상세 (GET /equipment/:id)

### rental_controller.js
- `rent` - 대여처리 (POST /rental/rent)
- `returnEquipment` - 반납처리 (POST /rental/return)
- `reserve` - 예약처리 (POST /rental/reserve)
- `history` - 기록조회 (GET /rental/history)

### admin_controller.js
- `userList` - 사용자목록 (GET /admin/users) [관리자]
- `createUser` - 등록 (POST /admin/users/create) [관리자]
- `updateUser` - 수정 (POST /admin/users/:id/update) [관리자]
- `resetPassword` - 비밀번호초기화 (POST /admin/users/:id/reset-password) [관리자]
- `deleteUser` - 삭제 (POST /admin/users/:id/delete) [관리자]

### 생성 파일
- `app/controllers/equipment_controller.js`
- `app/controllers/rental_controller.js`
- `app/controllers/admin_controller.js`
- `routes/equipment_route.js`
- `routes/rental_route.js`
- `routes/admin_route.js`

---

## 7단계: 뷰 (UI)

### 작업 내용
OPASNET Demo 화면 (장비현황.png, 장비기록.png) 참고하여 구현:
- 좌측 사이드바 네비게이션 (다크 테마)
- 상단 헤더바 (사용자정보, 로그아웃)
- 검색/필터 영역 + 결과 테이블

### 주요 화면

#### 장비현황 (equipment/list.ejs)
- 통계 카드 (전체/사용가능/대여중/예약중)
- 검색 필터 (구분, Vendor, 위치, 상태, 검색어)
- 결과 테이블 (No, 구분, Vendor, 모델명, 업링크, 파워이중화, 자산번호, S/N, 위치, 상태, 비고)
- 페이지네이션
- 행 클릭시 상세 페이지 이동

#### 장비 상세 (equipment/detail.ejs)
- 장비 정보 테이블
- 대여/반납/예약 폼 (상태에 따라 다른 UI)
- 대여 기록 테이블
- 수정/삭제 버튼 (관리자)

#### 장비 등록/수정 (equipment/form.ejs)
- 구분(select), Vendor, 모델명, 업링크, 파워이중화(select)
- 자산번호, S/N, 위치, 상태(select), 비고

#### 대여기록 (rental/history.ejs)
- 검색 필터 (구분, 검색어)
- 결과 테이블 + 페이지네이션

#### 사용자 관리 (admin/users.ejs)
- 사용자 등록 폼
- 사용자 목록 (인라인 수정, 비밀번호 초기화, 삭제)

### 생성 파일
- `app/views/layouts/default.ejs` - 공통 레이아웃
- `app/views/login.ejs` - 로그인
- `app/views/error.ejs` - 에러
- `app/views/equipment/list.ejs` - 장비현황
- `app/views/equipment/form.ejs` - 장비 등록/수정
- `app/views/equipment/detail.ejs` - 장비 상세
- `app/views/rental/history.ejs` - 대여기록
- `app/views/admin/users.ejs` - 사용자 관리

---

## 8단계: 유틸리티 + 정적 파일

### helpers.js
- `formatDate` / `formatDateTime` - 날짜 포맷
- `getPagination` - 페이지네이션 계산
- `getStatusLabel` / `getStatusBadgeClass` - 장비 상태 한글/배지
- `getActionBadgeClass` - 대여 액션 배지 클래스 (badge-rent/return/reserve)
- `getActionLabel` - 대여 액션 한글 변환

### 정적 파일
- `public/css/style.css` - 사이드바, 헤더, 카드, 테이블 등 커스텀 스타일
- `public/js/app.js` - 사이드바 토글

### 생성 파일
- `utils/helpers.js`
- `public/css/style.css`
- `public/js/app.js`
- `.gitignore`

---

## 전체 생성 파일 목록 (총 27개)

```
app.js
bin/www
package.json
.gitignore
CLAUDE.md
config/env.js
config/database.js
config/logger.js
config/.env.development
config/.env.production
config/.env.example
middleware/auth.js
routes/index_route.js
routes/equipment_route.js
routes/rental_route.js
routes/admin_route.js
app/controllers/auth_controller.js
app/controllers/equipment_controller.js
app/controllers/rental_controller.js
app/controllers/admin_controller.js
app/dao/user_dao.js
app/dao/equipment_dao.js
app/dao/rental_dao.js
app/views/layouts/default.ejs
app/views/login.ejs
app/views/error.ejs
app/views/equipment/list.ejs
app/views/equipment/form.ejs
app/views/equipment/detail.ejs
app/views/rental/history.ejs
app/views/admin/users.ejs
public/css/style.css
public/js/app.js
sql/init.sql
utils/helpers.js
docs/작업이력.md
```

---

## 9단계: UI 색상 리디자인 (뮤트 팔레트)

### 배경
- Bootstrap 기본 색상(btn-primary, bg-success 등)이 너무 다양하고 튀어서 전문적이지 않다는 피드백
- 채도를 낮춘 단일 톤 컬러 팔레트로 전면 교체

### 변경 내용

#### CSS 변수 신설 (`public/css/style.css`)
```css
--accent: #4a6fa5          /* 슬레이트 블루 메인 액센트 */
--color-available: #5b8a72 /* 차분한 녹색 */
--color-rented: #b07060    /* 차분한 적색 */
--color-reserved: #b09a5a  /* 차분한 황색 */
```

#### 커스텀 클래스 추가
- 버튼: `btn-accent`, `btn-subtle`, `btn-outline-muted`, `btn-muted-danger`
- 배지: `badge-available`, `badge-rented`, `badge-reserved`, `badge-rent`, `badge-return`, `badge-reserve`
- 기타: `thead-muted`, `card-header-muted`, `stat-total/stat-ok/stat-rented/stat-reserve`

#### 수정된 파일
- `public/css/style.css` - 전면 재작성
- `utils/helpers.js` - getActionBadgeClass, getActionLabel 추가, 배지 클래스 커스텀으로 변경
- `app/views/layouts/default.ejs` - 관리자 배지 뮤트 처리
- `app/views/login.ejs` - btn-accent 적용
- `app/views/equipment/list.ejs` - 통계카드, 테이블, 버튼 전체 뮤트
- `app/views/equipment/detail.ejs` - 카드헤더, 버튼, 배지 뮤트
- `app/views/equipment/form.ejs` - btn-accent, 필수표시 색상 변경
- `app/views/rental/history.ejs` - 액션 배지, 테이블 뮤트
- `app/views/admin/users.ejs` - 버튼, 카드헤더 뮤트

---

## 10단계: 더미 데이터 추가

### 작업 내용
- 일반 사용자 4명 추가 (김정수, 이영미, 박동현, 최수현)
- 대여기록 21건 추가 (대여/반납/예약 이력)
- RT002(id=5) 현재 대여중 상태와 일치하는 활성 대여기록 포함

### 수정 파일
- `sql/init.sql` - 사용자 INSERT + 대여기록 INSERT 추가

---

## 11단계: helpers 전역 설정 버그 수정

### 문제
- `/rental/history` 접속 시 `helpers.getActionBadgeClass is not a function` 에러 (500)
- express-ejs-layouts + Express 5 조합에서 컨트롤러 render 시 로컬변수 전달 누락 발생

### 해결
- `app.js`에서 `res.locals.helpers = helpers`로 전역 설정
- 모든 뷰에서 helpers 자동 접근 가능
- 컨트롤러에서 중복 `helpers` 전달 코드 제거

### 수정 파일
- `app.js` - res.locals.helpers 전역 설정 추가
- `app/controllers/equipment_controller.js` - render에서 helpers 제거
- `app/controllers/rental_controller.js` - render에서 helpers 제거

---

## 전체 생성 파일 목록 (총 29개)

```
app.js
bin/www
package.json
.gitignore
CLAUDE.md
config/env.js
config/database.js
config/logger.js
config/.env.development
config/.env.production
config/.env.example
middleware/auth.js
routes/index_route.js
routes/equipment_route.js
routes/rental_route.js
routes/admin_route.js
app/controllers/auth_controller.js
app/controllers/equipment_controller.js
app/controllers/rental_controller.js
app/controllers/admin_controller.js
app/dao/user_dao.js
app/dao/equipment_dao.js
app/dao/rental_dao.js
app/views/layouts/default.ejs
app/views/login.ejs
app/views/error.ejs
app/views/equipment/list.ejs
app/views/equipment/form.ejs
app/views/equipment/detail.ejs
app/views/rental/history.ejs
app/views/admin/users.ejs
public/css/style.css
public/js/app.js
sql/init.sql
utils/helpers.js
docs/작업이력.md
```

---

## 완료 항목
- [x] PostgreSQL에 DB 생성 및 init.sql 실행
- [x] 서버 실행 후 로그인 테스트
- [x] 장비현황/상세/등록/수정/삭제 동작 확인
- [x] 대여/반납/예약 플로우 동작 확인
- [x] 대여기록 조회 동작 확인
- [x] 사용자 관리 동작 확인
- [x] UI 색상 뮤트 팔레트 적용

## 다음 작업 (TODO)
- [ ] 필요시 엑셀 데이터 일괄 import 기능 추가
- [ ] 필요시 대여기록 엑셀 export 기능 추가
