<div class="page-header">
    <h4><i class="bi bi-people"></i> 사용자 관리
        <small>시스템 사용자를 관리할 수 있습니다.</small>
    </h4>
</div>

<% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<% } %>
<% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<% } %>

<!-- 사용자 등록 -->
<div class="card mb-3">
    <div class="card-header card-header-muted">
        <i class="bi bi-person-plus"></i> 사용자 등록
    </div>
    <div class="card-body">
        <form method="POST" action="/admin/users/create">
            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">아이디 <span style="color:var(--color-rented)">*</span></label>
                    <input type="text" name="username" class="form-control form-control-sm" placeholder="로그인 아이디" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">비밀번호 <span style="color:var(--color-rented)">*</span></label>
                    <input type="password" name="password" class="form-control form-control-sm" placeholder="비밀번호" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">이름 <span style="color:var(--color-rented)">*</span></label>
                    <input type="text" name="name" class="form-control form-control-sm" placeholder="이름" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">부서</label>
                    <input type="text" name="department" class="form-control form-control-sm" placeholder="부서">
                </div>
                <div class="col-md-2">
                    <label class="form-label">권한</label>
                    <select name="role" class="form-select form-select-sm">
                        <option value="user">일반사용자</option>
                        <option value="admin">관리자</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-accent btn-sm w-100">
                        <i class="bi bi-plus-lg"></i> 등록
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 사용자 목록 -->
<div class="card">
    <div class="card-header card-header-muted">
        <i class="bi bi-people"></i> 사용자 목록 ( <%= users.length %> 명 )
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm table-bordered mb-0">
                <thead class="thead-muted">
                    <tr>
                        <th class="text-center" style="width:50px">No.</th>
                        <th>아이디</th>
                        <th>이름</th>
                        <th>부서</th>
                        <th class="text-center">권한</th>
                        <th class="text-center">등록일</th>
                        <th class="text-center" style="width:200px">관리</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach((u, index) => { %>
                        <tr id="user-row-<%= u.id %>">
                            <td class="text-center"><%= index + 1 %></td>
                            <td><%= u.username %></td>
                            <td>
                                <input type="text" class="form-control form-control-sm" id="name-<%= u.id %>"
                                       value="<%= u.name %>" style="width:120px; display:inline-block">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" id="dept-<%= u.id %>"
                                       value="<%= u.department || '' %>" style="width:120px; display:inline-block">
                            </td>
                            <td class="text-center">
                                <select class="form-select form-select-sm" id="role-<%= u.id %>" style="width:110px; display:inline-block">
                                    <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>일반사용자</option>
                                    <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>관리자</option>
                                </select>
                            </td>
                            <td class="text-center"><%= new Date(u.created_at).toLocaleDateString('ko-KR') %></td>
                            <td class="text-center">
                                <button class="btn btn-outline-muted btn-sm" onclick="updateUser(<%= u.id %>)" title="수정">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-muted btn-sm" onclick="resetPassword(<%= u.id %>)" title="비밀번호 초기화">
                                    <i class="bi bi-key"></i>
                                </button>
                                <% if (u.username !== 'admin') { %>
                                    <button class="btn btn-muted-danger btn-sm" onclick="deleteUser(<%= u.id %>, '<%= u.username %>')" title="삭제">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function updateUser(id) {
    const name = document.getElementById('name-' + id).value;
    const department = document.getElementById('dept-' + id).value;
    const role = document.getElementById('role-' + id).value;

    fetch('/admin/users/' + id + '/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, department, role })
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
    })
    .catch(err => alert('오류가 발생했습니다.'));
}

function resetPassword(id) {
    const password = prompt('새 비밀번호를 입력하세요 (빈칸이면 1234로 초기화):');
    if (password === null) return;

    fetch('/admin/users/' + id + '/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password || '1234' })
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
    })
    .catch(err => alert('오류가 발생했습니다.'));
}

function deleteUser(id, username) {
    if (!confirm(username + ' 사용자를 삭제하시겠습니까?')) return;

    fetch('/admin/users/' + id + '/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
        if (result.result_yn === 1) location.reload();
    })
    .catch(err => alert('오류가 발생했습니다.'));
}
</script>
