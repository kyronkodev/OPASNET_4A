<div class="page-header">
    <h4>
        <i class="bi bi-hdd-rack"></i> 장비 상세
        <small><%= equipment.model_name %> (<%= equipment.asset_number %>)</small>
    </h4>
</div>

<div class="row">
    <!-- 장비 정보 카드 -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header card-header-muted d-flex justify-content-between align-items-center">
                <span><i class="bi bi-info-circle"></i> 장비 정보</span>
                <span class="badge <%= helpers.getStatusBadgeClass(equipment.status) %>">
                    <%= helpers.getStatusLabel(equipment.status) %>
                </span>
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:120px">구분</th><td><%= equipment.category || '-' %></td></tr>
                        <tr><th>Vendor</th><td><%= equipment.vendor || '-' %></td></tr>
                        <tr><th>모델명</th><td class="fw-bold"><%= equipment.model_name || '-' %></td></tr>
                        <tr><th>업링크</th><td><%= equipment.uplink || '-' %></td></tr>
                        <tr><th>파워이중화</th><td><%= equipment.power_redundancy || '-' %></td></tr>
                        <tr><th>자산번호</th><td><%= equipment.asset_number || '-' %></td></tr>
                        <tr><th>S/N</th><td><%= equipment.serial_number || '-' %></td></tr>
                        <tr><th>위치</th><td><%= equipment.location || '-' %></td></tr>
                        <tr><th>비고</th><td><%= equipment.description || '-' %></td></tr>
                        <tr><th>등록일</th><td><%= helpers.formatDateTime(equipment.created_at) %></td></tr>
                        <tr><th>수정일</th><td><%= helpers.formatDateTime(equipment.updated_at) %></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white d-flex gap-2">
                <% if (user.role === 'admin') { %>
                    <a href="/equipment/<%= equipment.id %>/edit" class="btn btn-outline-muted btn-sm">
                        <i class="bi bi-pencil"></i> 수정
                    </a>
                    <button class="btn btn-muted-danger btn-sm" onclick="deleteEquipment(<%= equipment.id %>)">
                        <i class="bi bi-trash"></i> 삭제
                    </button>
                <% } %>
                <a href="/equipment" class="btn btn-subtle btn-sm">
                    <i class="bi bi-arrow-left"></i> 목록
                </a>
            </div>
        </div>
    </div>

    <!-- 대여/반납/예약 액션 -->
    <div class="col-md-6">
        <% if (equipment.status === 'available') { %>
            <!-- 대여 폼 -->
            <div class="card mb-3">
                <div class="card-header card-header-muted">
                    <i class="bi bi-arrow-left-right"></i> 대여 처리
                </div>
                <div class="card-body">
                    <form id="rentForm">
                        <input type="hidden" name="equipment_id" value="<%= equipment.id %>">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">대여자 이름 <span style="color:var(--color-rented)">*</span></label>
                                <input type="text" name="borrower_name" class="form-control form-control-sm" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">대여자 부서 <span style="color:var(--color-rented)">*</span></label>
                                <input type="text" name="borrower_dept" class="form-control form-control-sm" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">대여일</label>
                                <input type="datetime-local" name="rent_date" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">반납예정일</label>
                                <input type="datetime-local" name="return_date" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">사용장소</label>
                                <input type="text" name="use_location" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">사용목적</label>
                                <input type="text" name="purpose" class="form-control form-control-sm">
                            </div>
                            <div class="col-12">
                                <label class="form-label">특이사항</label>
                                <textarea name="notes" class="form-control form-control-sm" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button type="button" class="btn btn-accent btn-sm" onclick="processRent()">
                                <i class="bi bi-arrow-right-circle"></i> 대여
                            </button>
                            <button type="button" class="btn btn-outline-muted btn-sm" onclick="processReserve()">
                                <i class="bi bi-calendar-check"></i> 예약
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        <% } else if (equipment.status === 'rented' || equipment.status === 'reserved') { %>
            <!-- 현재 대여 정보 + 반납 폼 -->
            <div class="card mb-3">
                <div class="card-header card-header-muted">
                    <i class="bi bi-info-circle"></i> 현재 대여 정보
                </div>
                <div class="card-body">
                    <% if (activeRental) { %>
                        <table class="table table-sm mb-3">
                            <tbody>
                                <tr><th style="width:100px">대여자</th><td><%= activeRental.borrower_name %> (<%= activeRental.borrower_dept %>)</td></tr>
                                <tr><th>대여일</th><td><%= helpers.formatDateTime(activeRental.rent_date) %></td></tr>
                                <tr><th>반납예정일</th><td><%= helpers.formatDateTime(activeRental.return_date) %></td></tr>
                                <tr><th>사용장소</th><td><%= activeRental.use_location || '-' %></td></tr>
                                <tr><th>사용목적</th><td><%= activeRental.purpose || '-' %></td></tr>
                                <tr><th>처리자</th><td><%= activeRental.processor_name || '-' %></td></tr>
                            </tbody>
                        </table>
                    <% } %>
                    <form id="returnForm">
                        <input type="hidden" name="equipment_id" value="<%= equipment.id %>">
                        <% if (activeRental) { %>
                            <input type="hidden" name="rental_id" value="<%= activeRental.id %>">
                        <% } %>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">반납 위치</label>
                                <input type="text" name="return_location" class="form-control form-control-sm" value="가산">
                            </div>
                            <div class="col-12">
                                <label class="form-label">특이사항</label>
                                <textarea name="notes" class="form-control form-control-sm" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-accent btn-sm" onclick="processReturn()">
                                <i class="bi bi-check-circle"></i> 반납 처리
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        <% } %>
    </div>
</div>

<!-- 대여기록 -->
<div class="card mt-3">
    <div class="card-header card-header-muted">
        <i class="bi bi-journal-text"></i> 대여 기록
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm table-bordered mb-0">
                <thead class="thead-muted">
                    <tr>
                        <th class="text-center" style="width:50px">No.</th>
                        <th class="text-center">구분</th>
                        <th>대여자</th>
                        <th>부서</th>
                        <th>대여일</th>
                        <th>반납예정일</th>
                        <th>실제반납일</th>
                        <th>사용장소</th>
                        <th>사용목적</th>
                        <th>처리자</th>
                        <th>특이사항</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (rentalHistory.length === 0) { %>
                        <tr><td colspan="11" class="text-center py-3 text-muted">대여 기록이 없습니다.</td></tr>
                    <% } else { %>
                        <% rentalHistory.forEach((rh, index) => { %>
                            <tr>
                                <td class="text-center"><%= index + 1 %></td>
                                <td class="text-center">
                                    <span class="badge <%= helpers.getActionBadgeClass(rh.action) %>">
                                        <%= helpers.getActionLabel(rh.action) %>
                                    </span>
                                </td>
                                <td><%= rh.borrower_name || '-' %></td>
                                <td><%= rh.borrower_dept || '-' %></td>
                                <td><%= helpers.formatDateTime(rh.rent_date) %></td>
                                <td><%= helpers.formatDateTime(rh.return_date) %></td>
                                <td><%= helpers.formatDateTime(rh.actual_return_date) %></td>
                                <td><%= rh.use_location || '-' %></td>
                                <td><%= rh.purpose || '-' %></td>
                                <td><%= rh.processor_name || '-' %></td>
                                <td><%= rh.notes || '-' %></td>
                            </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function processRent() {
    const form = document.getElementById('rentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    if (!data.borrower_name || !data.borrower_dept) {
        alert('대여자 이름과 부서는 필수입니다.');
        return;
    }

    fetch('/rental/rent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
        if (result.result_yn === 1) location.reload();
    })
    .catch(err => alert('오류가 발생했습니다.'));
}

function processReserve() {
    const form = document.getElementById('rentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    if (!data.borrower_name || !data.borrower_dept) {
        alert('대여자 이름과 부서는 필수입니다.');
        return;
    }

    fetch('/rental/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
        if (result.result_yn === 1) location.reload();
    })
    .catch(err => alert('오류가 발생했습니다.'));
}

function processReturn() {
    if (!confirm('반납 처리하시겠습니까?')) return;

    const form = document.getElementById('returnForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    fetch('/rental/return', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
        if (result.result_yn === 1) location.reload();
    })
    .catch(err => alert('오류가 발생했습니다.'));
}

function deleteEquipment(id) {
    if (!confirm('정말 삭제하시겠습니까?\n삭제된 장비는 복구할 수 없습니다.')) return;

    fetch('/equipment/' + id + '/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(result => {
        alert(result.return_msg);
        if (result.result_yn === 1) location.href = '/equipment';
    })
    .catch(err => alert('오류가 발생했습니다.'));
}
</script>
